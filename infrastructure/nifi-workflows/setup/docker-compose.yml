services:
  # Apache NiFi Workflow Orchestrator
  nifi:
    build:
      context: ../services/nifi
      dockerfile: Dockerfile
    container_name: nifi-orchestrator
    ports:
      - "8443:8443"   # HTTPS UI
      - "9443:9443"   # Remote Process Group
      - "8080:8080"   # HTTP (optional)
      - "9091:9091"   # ListenHTTP SP01
      - "9092:9092"   # ListenHTTP SP02
      - "9093:9093"   # ListenHTTP SP03
      - "9094:9094"   # ListenHTTP SP04
      - "9095:9095"   # ListenHTTP SP05
      - "9096:9096"   # ListenHTTP SP06
      - "9097:9097"   # ListenHTTP SP07
      - "9098:9098"   # ListenHTTP SP08
      - "9099:9099"   # ListenHTTP SP09
      - "9100:9100"   # ListenHTTP SP10
      - "9101:9101"   # ListenHTTP SP11
    environment:
      - SINGLE_USER_CREDENTIALS_USERNAME=${NIFI_USER:-admin}
      - SINGLE_USER_CREDENTIALS_PASSWORD=${NIFI_PASSWORD:-adminadminadmin}
      - NIFI_WEB_HTTPS_PORT=8443
      - NIFI_WEB_HTTP_PORT=8080
      - NIFI_CLUSTER_IS_NODE=false
      - NIFI_CLUSTER_NODE_PROTOCOL_PORT=9999
      - NIFI_ZK_CONNECT_STRING=zookeeper:2181
      - NIFI_ELECTION_MAX_WAIT=1 min
      - NIFI_SENSITIVE_PROPS_KEY=${NIFI_SENSITIVE_KEY:-nifichangeme}
      - NIFI_JVM_HEAP_INIT=2g
      - NIFI_JVM_HEAP_MAX=4g
      - GROQ_API_KEY=${GROQ_API_KEY}
      - NIFI_REGISTRY_URL=http://nifi-registry:18080
    volumes:
      - nifi_database_repository:/opt/nifi/nifi-current/database_repository
      - nifi_flowfile_repository:/opt/nifi/nifi-current/flowfile_repository
      - nifi_content_repository:/opt/nifi/nifi-current/content_repository
      - nifi_provenance_repository:/opt/nifi/nifi-current/provenance_repository
      - nifi_state:/opt/nifi/nifi-current/state
      - nifi_logs:/opt/nifi/nifi-current/logs
      - ./nifi-templates:/opt/nifi/nifi-current/conf/templates
      - ./nifi-extensions:/opt/nifi/nifi-current/extensions
    depends_on:
      postgres:
        condition: service_healthy
      nifi-registry:
        condition: service_healthy
      redis:
        condition: service_started
      zookeeper:
        condition: service_healthy
    networks:
      - provvedimenti-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "-k", "https://localhost:8443/nifi-api/system-diagnostics"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s

  # PostgreSQL Database with pgvector extension
  postgres:
    image: pgvector/pgvector:pg15
    container_name: postgres-db
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_DB=provvedimenti
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-postgrespassword}
    volumes:
      - /Users/giangioiz/postgresql/data:/var/lib/postgresql/data
      - ./init-databases.sh:/docker-entrypoint-initdb.d/01-init-databases.sh
      - ./init-db.sql:/docker-entrypoint-initdb.d/02-init-tables.sql
      - ./init-nifi-registry.sql:/docker-entrypoint-initdb.d/03-init-nifi-registry.sql
      - ./init-nifi-audit.sql:/docker-entrypoint-initdb.d/04-init-nifi-audit.sql
    networks:
      - provvedimenti-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # Redis Cache
  redis:
    image: redis:7-alpine
    container_name: redis-cache
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes --maxmemory 2gb --maxmemory-policy allkeys-lru
    volumes:
      - redis_data:/data
    networks:
      - provvedimenti-network
    restart: unless-stopped

  # ZooKeeper for NiFi clustering
  zookeeper:
    image: zookeeper:3.8
    container_name: zookeeper
    ports:
      - "2181:2181"
    environment:
      - ZOOKEEPER_CLIENT_PORT=2181
      - ZOOKEEPER_TICK_TIME=2000
      - ZOOKEEPER_SYNC_LIMIT=5
      - ZOOKEEPER_INIT_LIMIT=10
    volumes:
      - zookeeper_data:/data
      - zookeeper_datalog:/datalog
    networks:
      - provvedimenti-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "2181"]
      interval: 30s
      timeout: 10s
      retries: 5

  # Neo4j Knowledge Graph
  neo4j:
    image: neo4j:5.12-community
    container_name: neo4j-knowledge-graph
    ports:
      - "7474:7474"  # HTTP
      - "7687:7687"  # Bolt
    environment:
      - NEO4J_AUTH=neo4j/${NEO4J_PASSWORD:-neo4jpassword}
      - NEO4J_server_memory_heap_initial__size=512m
      - NEO4J_server_memory_heap_max__size=2G
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
    networks:
      - provvedimenti-network
    restart: unless-stopped

  # MinIO Object Storage
  minio:
    image: minio/minio:latest
    container_name: minio-storage
    ports:
      - "9000:9000"  # API
      - "9001:9001"  # Console
    environment:
      - MINIO_ROOT_USER=${MINIO_USER:-minioadmin}
      - MINIO_ROOT_PASSWORD=${MINIO_PASSWORD:-minioadmin}
    command: server /data --console-address ":9001"
    volumes:
      - minio_data:/data
    networks:
      - provvedimenti-network
    restart: unless-stopped

  # SP01 - EML Parser & Email Intelligence Service
  sp01-eml-parser:
    build:
      context: ../services/sp01
      dockerfile: Dockerfile
    container_name: sp01-eml-parser
    ports:
      - "5001:5001"
    environment:
      - DATABASE_URL=postgresql://postgres:${POSTGRES_PASSWORD:-postgrespassword}@postgres:5432/provvedimenti
      - REDIS_URL=redis://redis:6379
      - GROQ_API_KEY=${GROQ_API_KEY}
    depends_on:
      - postgres
      - redis
    networks:
      - provvedimenti-network
    restart: unless-stopped

  # SP02 - Document Extractor & Attachment Classifier Service
  sp02-document-extractor:
    build:
      context: ../services/sp02
      dockerfile: Dockerfile
    container_name: sp02-document-extractor
    ports:
      - "5002:5002"
    environment:
      - DATABASE_URL=postgresql://postgres:${POSTGRES_PASSWORD:-postgrespassword}@postgres:5432/provvedimenti
      - REDIS_URL=redis://redis:6379
      - MINIO_ENDPOINT=minio:9000
      - MINIO_ACCESS_KEY=${MINIO_USER:-minioadmin}
      - MINIO_SECRET_KEY=${MINIO_PASSWORD:-minioadmin}
      - GROQ_API_KEY=${GROQ_API_KEY}
    depends_on:
      - postgres
      - redis
      - minio
    networks:
      - provvedimenti-network
    restart: unless-stopped

  # SP03 - Procedural Classifier Service (renamed from SP00)
  sp03-procedural-classifier:
    build:
      context: ../services/sp03
      dockerfile: Dockerfile
    container_name: sp03-procedural-classifier
    ports:
      - "5003:5003"
    environment:
      - DATABASE_URL=postgresql://postgres:${POSTGRES_PASSWORD:-postgrespassword}@postgres:5432/provvedimenti
      - REDIS_URL=redis://redis:6379
      - GROQ_API_KEY=${GROQ_API_KEY}
    depends_on:
      - postgres
      - redis
    networks:
      - provvedimenti-network
    restart: unless-stopped

  # SP04 - Knowledge Base Service (Placeholder API)
  sp04-knowledge-base:
    build:
      context: ../services/sp04
      dockerfile: Dockerfile
    container_name: sp04-knowledge-base
    ports:
      - "5004:5004"
    environment:
      - DATABASE_URL=postgresql://postgres:${POSTGRES_PASSWORD:-postgrespassword}@postgres:5432/provvedimenti
      - REDIS_URL=redis://redis:6379
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=${NEO4J_PASSWORD:-neo4jpassword}
      - GROQ_API_KEY=${GROQ_API_KEY}
    depends_on:
      - postgres
      - redis
      - neo4j
    networks:
      - provvedimenti-network
    restart: unless-stopped

  # HITL Manager - Human in the Loop Service
  hitl-manager:
    build:
      context: ../services/hitl
      dockerfile: Dockerfile
    container_name: hitl-manager
    ports:
      - "5009:5009"
    environment:
      - POSTGRES_HOST=postgres
      - POSTGRES_DB=provvedimenti
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-postgrespassword}
      - POSTGRES_PORT=5432
    depends_on:
      - postgres
    networks:
      - provvedimenti-network
    restart: unless-stopped

  # SP07 - Content Classifier Service (Disponibile ma commentato - opzionale)
  # Decommenta solo se necessario per classificazione avanzata
  # Altrimenti usa Groq direttamente nei workflow NiFi
  # sp07-content-classifier:
  #   build:
  #     context: ../..
  #     dockerfile: infrastructure/nifi-workflows/services/sp07/Dockerfile
  #   container_name: sp07-content-classifier
  #   ports:
  #     - "5007:5007"
  #   environment:
  #     - DATABASE_URL=postgresql://postgres:${POSTGRES_PASSWORD:-postgrespassword}@postgres:5432/provvedimenti
  #     - REDIS_URL=redis://redis:6379
  #     - GROQ_API_KEY=${GROQ_API_KEY}
  #   depends_on:
  #     - postgres
  #     - redis
  #   networks:
  #     - provvedimenti-network
  #   restart: unless-stopped

  gotenberg:
    image: gotenberg/gotenberg:8
    container_name: gotenberg
    ports:
      - "3000:3000"
    environment:
      DISABLE_GOOGLE_CHROME: 1  # Disabilita Chrome se non necessario
    restart: unless-stopped

  # NiFi Registry for template management
  nifi-registry:
    build:
      context: ../services/nifi-registry
      dockerfile: Dockerfile
    container_name: nifi-registry
    ports:
      - "18080:18080"
    environment:
      - NIFI_REGISTRY_WEB_HTTP_PORT=18080
      - NIFI_REGISTRY_DB_CLASS=org.postgresql.Driver
      - NIFI_REGISTRY_DB_URL=jdbc:postgresql://postgres:5432/nifi_registry
      - NIFI_REGISTRY_DB_USER=postgres
      - NIFI_REGISTRY_DB_PASS=${POSTGRES_PASSWORD:-postgrespassword}
      - NIFI_REGISTRY_FLOW_STORAGE_DIR=/opt/nifi-registry/nifi-registry-current/flow_storage
    volumes:
      - nifi_registry_flow_storage:/opt/nifi-registry/nifi-registry-current/flow_storage
    depends_on:
      postgres:
        condition: service_healthy  # ðŸ‘ˆ Aspetta che PostgreSQL sia healthy
    networks:
      - provvedimenti-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:18080/nifi-registry"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

volumes:
  nifi_database_repository:
    driver: local
  nifi_flowfile_repository:
    driver: local
  nifi_content_repository:
    driver: local
  nifi_provenance_repository:
    driver: local
  nifi_state:
    driver: local
  nifi_logs:
    driver: local
  redis_data:
    driver: local
  zookeeper_data:
    driver: local
  zookeeper_datalog:
    driver: local
  neo4j_data:
    driver: local
  neo4j_logs:
    driver: local
  minio_data:
    driver: local
  nifi_registry_data:
    driver: local
  nifi_registry_database:
    driver: local
  nifi_registry_flow_storage:
    driver: local

networks:
  provvedimenti-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

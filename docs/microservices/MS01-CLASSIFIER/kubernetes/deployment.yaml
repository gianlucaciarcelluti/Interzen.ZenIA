apiVersion: apps/v1
kind: Deployment
metadata:
  name: ms01-classifier
  namespace: zendata
  labels:
    app: ms01-classifier
    version: v1
    component: analytics

spec:
  replicas: 3

  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0

  selector:
    matchLabels:
      app: ms01-classifier

  template:
    metadata:
      labels:
        app: ms01-classifier
        version: v1
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8001"
        prometheus.io/path: "/metrics"

    spec:
      serviceAccountName: ms01-classifier

      # Init containers for dependencies
      initContainers:
        - name: wait-for-postgres
          image: busybox:1.35
          command:
            - sh
            - -c
            - |
              until nc -z postgres.zendata 5432; do
                echo 'Waiting for PostgreSQL...'
                sleep 5
              done
              echo 'PostgreSQL is ready'

        - name: wait-for-redis
          image: busybox:1.35
          command:
            - sh
            - -c
            - |
              until nc -z redis.zendata 6379; do
                echo 'Waiting for Redis...'
                sleep 5
              done
              echo 'Redis is ready'

      # Main container
      containers:
        - name: classifier
          image: zendata/ms01-classifier:latest
          imagePullPolicy: Always

          ports:
            - name: http
              containerPort: 8001
              protocol: TCP
            - name: metrics
              containerPort: 9090
              protocol: TCP

          # Environment Variables
          env:
            - name: SERVICE_NAME
              value: "MS01-CLASSIFIER"

            - name: CLASSIFIER_MODEL_VERSION
              valueFrom:
                configMapKeyRef:
                  name: classifier-config
                  key: model.version

            - name: CLASSIFICATION_THRESHOLD
              valueFrom:
                configMapKeyRef:
                  name: classifier-config
                  key: classification.threshold

            - name: DATABASE_URL
              valueFrom:
                secretKeyRef:
                  name: classifier-db-secret
                  key: database-url

            - name: REDIS_URL
              value: "redis://redis.zendata:6379/1"

            - name: JWT_SECRET_KEY
              valueFrom:
                secretKeyRef:
                  name: classifier-jwt-secret
                  key: secret-key

            - name: LOG_LEVEL
              valueFrom:
                configMapKeyRef:
                  name: classifier-config
                  key: log.level

            - name: ENABLE_ML_CLASSIFICATION
              value: "true"

            - name: ENABLE_QUALITY_CHECKS
              value: "true"

            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name

            - name: POD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace

          # Resource Limits
          resources:
            requests:
              cpu: 500m
              memory: 512Mi
            limits:
              cpu: 2000m
              memory: 2Gi

          # Liveness Probe - restart if unhealthy
          livenessProbe:
            httpGet:
              path: /health
              port: http
            initialDelaySeconds: 60
            periodSeconds: 30
            timeoutSeconds: 10
            failureThreshold: 3

          # Readiness Probe - remove from service if not ready
          readinessProbe:
            httpGet:
              path: /ready
              port: http
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 2

          # Startup Probe - wait for container to start
          startupProbe:
            httpGet:
              path: /health
              port: http
            initialDelaySeconds: 0
            periodSeconds: 5
            timeoutSeconds: 5
            failureThreshold: 12  # 12 * 5 = 60 seconds max startup time

          # Volume Mounts
          volumeMounts:
            - name: models
              mountPath: /models
              readOnly: true

            - name: config
              mountPath: /etc/classifier
              readOnly: true

            - name: logs
              mountPath: /var/log/classifier

            - name: tmp
              mountPath: /tmp

          # Security Context
          securityContext:
            runAsNonRoot: true
            runAsUser: 1000
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop:
                - ALL

      # Volumes
      volumes:
        - name: models
          configMap:
            name: classifier-models
            defaultMode: 0444

        - name: config
          configMap:
            name: classifier-config
            defaultMode: 0444

        - name: logs
          emptyDir:
            sizeLimit: 1Gi

        - name: tmp
          emptyDir:
            sizeLimit: 500Mi

      # Pod Security & Scheduling
      securityContext:
        fsGroup: 1000

      # Affinity Rules
      affinity:
        # Pod Anti-Affinity: spread replicas across nodes
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchExpressions:
                    - key: app
                      operator: In
                      values:
                        - ms01-classifier
                topologyKey: kubernetes.io/hostname

        # Node Affinity: prefer nodes with ssd
        nodeAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 50
              preference:
                matchExpressions:
                  - key: disk-type
                    operator: In
                    values:
                      - ssd

      # Termination Grace Period
      terminationGracePeriodSeconds: 30

      # Restart Policy
      restartPolicy: Always

---

apiVersion: v1
kind: Service
metadata:
  name: ms01-classifier
  namespace: zendata
  labels:
    app: ms01-classifier

spec:
  type: ClusterIP

  ports:
    - name: http
      port: 80
      targetPort: http
      protocol: TCP

    - name: metrics
      port: 9090
      targetPort: metrics
      protocol: TCP

  selector:
    app: ms01-classifier

  sessionAffinity: None

---

apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: ms01-classifier-hpa
  namespace: zendata

spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: ms01-classifier

  minReplicas: 3
  maxReplicas: 10

  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70

    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 75

  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
        - type: Percent
          value: 50
          periodSeconds: 60

    scaleUp:
      stabilizationWindowSeconds: 0
      policies:
        - type: Percent
          value: 100
          periodSeconds: 30
        - type: Pods
          value: 2
          periodSeconds: 30
      selectPolicy: Max

---

apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: ms01-classifier-pdb
  namespace: zendata

spec:
  maxUnavailable: 1
  selector:
    matchLabels:
      app: ms01-classifier

---

apiVersion: v1
kind: ServiceAccount
metadata:
  name: ms01-classifier
  namespace: zendata

---

apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: ms01-classifier-role
  namespace: zendata

rules:
  - apiGroups: [""]
    resources: ["configmaps"]
    verbs: ["get", "list", "watch"]

  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["get"]

---

apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: ms01-classifier-rolebinding
  namespace: zendata

roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: ms01-classifier-role

subjects:
  - kind: ServiceAccount
    name: ms01-classifier
    namespace: zendata

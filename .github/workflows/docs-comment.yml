name: Documentation Commenter

on:
  pull_request_target:
    types: [opened, reopened, synchronize]

permissions:
  issues: write
  actions: read
  checks: read

jobs:
  post-validation-comment:
    runs-on: ubuntu-latest
    name: Validation summary comment (backup)

    steps:
      - name: Post validation summary comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const pr = context.payload.pull_request;
            const head_sha = pr.head.sha;

            // Try to find the most recent 'Documentation Validation' workflow run for this PR commit
            const workflowFile = 'docs-validation.yml';
            const runs = await github.actions.listWorkflowRuns({
              owner,
              repo,
              workflow_id: workflowFile,
              per_page: 50
            });

            // Find run matching head_sha
            const matched = runs.data.workflow_runs.find(r => r.head_sha === head_sha);

            let body = '## üìã Documentation Validation Workflow\n\n';

            if (!matched) {
              body += '‚è≥ Validation run not yet matched for this commit.\n';
              body += 'Please check the [Actions tab](../../actions) for the validation results.\n';
            } else {
              const conclusion = matched.conclusion || matched.status;
              const statusEmoji = conclusion === 'success' ? '‚úÖ' : conclusion === 'failure' ? '‚ùå' : '‚è≥';

              body += `${statusEmoji} **Status**: ${conclusion.toUpperCase()}\n`;
              body += `üîó [View Validation Run ‚Üí](${matched.html_url})\n\n`;

              body += '### üìä How to Review Results:\n';
              body += '1. Click "View Validation Run" link above\n';
              body += '2. Go to "Artifacts" section\n';
              body += '3. Download "validation-reports" zip file\n';
              body += '4. Review JSON reports for detailed validation data\n\n';

              if (conclusion === 'failure') {
                body += '### ‚ùå Critical Issues Found\n';
                body += 'TIER 1 validation failed. Please fix critical issues before merging.\n';
                body += 'Check the validation reports for specific errors.\n';
              } else {
                body += '### ‚úÖ All Critical Validations Pass\n';
                body += 'TIER 1 checks are complete. TIER 2-3 warnings may exist (non-blocking).\n';
              }
            }

            body += '\n---\n_Comment posted by Documentation Validation workflow (safe context: pull_request_target)_';

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: pr.number,
              body
            });

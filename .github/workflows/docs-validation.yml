name: Documentation Validation

on:
  push:
    branches: [ main, razionalizzazione-sp, develop ]
    paths:
      - 'docs/**'
      - 'scripts/verify_*.py'
      - 'scripts/run_all_checks.sh'
      - '.github/workflows/docs-validation.yml'
  pull_request:
    branches: [ main, razionalizzazione-sp ]
    paths:
      - 'docs/**'
      - 'scripts/verify_*.py'
      - 'scripts/run_all_checks.sh'

jobs:
  validate-documentation:
    runs-on: ubuntu-latest
    name: Validate Documentation (TIER 1 Critical)

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Run Complete Validation Suite
        id: validation
        run: |
          chmod +x scripts/run_all_checks.sh

          # Run validation suite and capture output
          ./scripts/run_all_checks.sh 2>&1 | tee validation_output.txt
          validation_exit_code=${PIPESTATUS[0]}

          echo "exit_code=$validation_exit_code" >> $GITHUB_OUTPUT

          # Check TIER 1 result
          if grep -q "âœ… TIER 1 PASS" validation_output.txt; then
            echo "tier1_result=PASS" >> $GITHUB_OUTPUT
          else
            echo "tier1_result=FAIL" >> $GITHUB_OUTPUT
          fi

      - name: Upload validation reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: validation-reports
          path: scripts/reports/
          retention-days: 30

      - name: Display validation summary
        if: always()
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "VALIDATION SUMMARY"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          tail -50 validation_output.txt
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: Check TIER 1 Results
        id: check_tier1
        run: |
          if grep -q "âœ… TIER 1 PASS" validation_output.txt; then
            echo "status=success"
            echo "TIER 1: âœ… PASS - Documentation is production ready"
            exit 0
          else
            echo "status=failure"
            echo "TIER 1: âŒ FAIL - Critical validation errors must be fixed"

            # Extract critical issues for clearer feedback
            if grep -q "Critical Issues:" validation_output.txt; then
              echo ""
              echo "Critical issues found. See validation-reports artifact for details:"
              grep -A 20 "Critical Issues:" validation_output.txt || true
            fi
            exit 1
          fi

      - name: Post PR Comment with Validation Results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const output = fs.readFileSync('validation_output.txt', 'utf8');

            // Determine status
            const tier1Pass = output.includes('âœ… TIER 1 PASS');
            const statusEmoji = tier1Pass ? 'âœ…' : 'âŒ';
            const statusText = tier1Pass ? 'PASS' : 'FAIL';

            let comment = '## ğŸ“‹ Documentation Validation Results\n\n';
            comment += `${statusEmoji} **TIER 1 (Critical)**: ${statusText}\n\n`;

            if (tier1Pass) {
              comment += 'All critical documentation validations passed! Your PR is ready for merge.\n\n';
              comment += '**Status**: TIER 2-3 warnings may exist (non-blocking)\n';
            } else {
              comment += 'Critical validation errors must be fixed before merging.\n\n';
              comment += '**Action Required**: Review the validation artifacts and fix the errors.\n';
            }

            comment += '\n### ğŸ“Š How to Review Results:\n';
            comment += '1. Go to the [Actions tab](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})\n';
            comment += '2. Download the "validation-reports" artifact\n';
            comment += '3. Review the JSON files for detailed validation data\n';
            comment += '4. Run locally: `./scripts/run_all_checks.sh` for debugging\n';

            comment += '\n---\n';
            comment += '_Validation completed at ' + new Date().toISOString() + '_';

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

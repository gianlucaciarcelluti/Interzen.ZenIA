apiVersion: v1
kind: ConfigMap
metadata:
  name: ms07-config
  namespace: zenia
  labels:
    app: ms07-distributor
    component: configuration
data:
  # Database Configuration
  DB_HOST: "postgresql.zenia.svc.cluster.local"
  DB_PORT: "5432"
  DB_NAME: "zenia_distributor"
  DB_SSL_MODE: "require"
  DB_CONNECTION_TIMEOUT: "30"
  DB_POOL_SIZE: "20"
  DB_MAX_OVERFLOW: "30"

  # Redis Configuration
  REDIS_HOST: "localhost"
  REDIS_PORT: "6379"
  REDIS_DB: "0"
  REDIS_CONNECTION_TIMEOUT: "5"
  REDIS_POOL_SIZE: "20"
  REDIS_MAX_CONNECTIONS: "50"

  # API Configuration
  API_HOST: "0.0.0.0"
  API_PORT: "8000"
  API_WORKERS: "4"
  API_WORKER_TIMEOUT: "300"
  API_MAX_REQUEST_SIZE: "104857600"  # 100MB

  # Security Configuration
  CORS_ALLOWED_ORIGINS: "https://*.zenia.local,https://*.agenzia-ambiente.it"
  RATE_LIMIT_REQUESTS: "1000"
  RATE_LIMIT_WINDOW_SECONDS: "60"
  BURST_LIMIT: "200"

  # Distribution Configuration
  DISTRIBUTION_DEFAULT_TIMEOUT: "300"
  DISTRIBUTION_MAX_TIMEOUT: "1800"
  DISTRIBUTION_DEFAULT_RETRIES: "3"
  DISTRIBUTION_MAX_RETRIES: "5"
  DISTRIBUTION_BACKOFF_MULTIPLIER: "2.0"
  DISTRIBUTION_MAX_BACKOFF: "300"
  DISTRIBUTION_CIRCUIT_BREAKER_FAILURE_THRESHOLD: "5"
  DISTRIBUTION_CIRCUIT_BREAKER_RECOVERY_TIMEOUT: "60"

  # Queue Configuration
  QUEUE_MAX_LENGTH: "10000"
  QUEUE_PROCESSING_BATCH_SIZE: "50"
  QUEUE_DEAD_LETTER_TTL: "604800"  # 7 days
  QUEUE_MONITORING_INTERVAL: "30"

  # Worker Configuration
  WORKER_CONCURRENCY: "10"
  WORKER_HEARTBEAT_INTERVAL: "30"
  WORKER_GRACEFUL_SHUTDOWN_TIMEOUT: "60"
  WORKER_MAX_MEMORY_MB: "1024"

  # Monitoring Configuration
  METRICS_ENABLED: "true"
  METRICS_PORT: "9090"
  HEALTH_CHECK_INTERVAL: "30"
  LOG_LEVEL: "INFO"
  LOG_FORMAT: "json"
  LOG_MAX_SIZE: "100"
  LOG_MAX_BACKUPS: "5"
  LOG_MAX_AGE: "30"

  # Business Rules Configuration
  RULES_ENGINE_ENABLED: "true"
  RULES_CACHE_TTL: "300"
  RULES_MAX_CONDITIONS: "50"
  RULES_EVALUATION_TIMEOUT: "10"

  # Destination Configuration
  DESTINATION_HEALTH_CHECK_INTERVAL: "60"
  DESTINATION_HEALTH_CHECK_TIMEOUT: "10"
  DESTINATION_CONNECTION_POOL_SIZE: "20"
  DESTINATION_MAX_KEEPALIVE: "100"

  # Feature Flags
  FEATURE_BULK_DISTRIBUTION: "true"
  FEATURE_INTELLIGENT_ROUTING: "true"
  FEATURE_CIRCUIT_BREAKER: "true"
  FEATURE_DEAD_LETTER_QUEUE: "true"
  FEATURE_TRANSFORMATION_ENGINE: "true"

  # External Integrations
  MS06_AGGREGATOR_URL: "https://ms06-aggregator.zenia.svc.cluster.local"
  MS09_REPORTER_URL: "https://ms09-reporter.zenia.svc.cluster.local"
  EXTERNAL_API_TIMEOUT: "30"
  EXTERNAL_API_MAX_RETRIES: "3"

  # Data Retention
  DISTRIBUTION_RETENTION_DAYS: "90"
  ATTEMPT_LOG_RETENTION_DAYS: "30"
  METRICS_RETENTION_DAYS: "365"
  AUDIT_LOG_RETENTION_DAYS: "2555"  # 7 years

  # GDPR Compliance
  GDPR_DATA_MASKING: "true"
  GDPR_RIGHT_TO_ERASURE: "true"
  GDPR_DATA_PORTABILITY: "true"
  GDPR_CONSENT_MANAGEMENT: "true"

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: ms07-redis-config
  namespace: zenia
  labels:
    app: ms07-distributor
    component: redis
data:
  redis.conf: |
    bind 0.0.0.0
    port 6379
    timeout 300
    tcp-keepalive 300
    maxmemory 256mb
    maxmemory-policy allkeys-lru
    save 900 1
    save 300 10
    save 60 10000
    appendonly yes
    appendfilename "appendonly.aof"
    appendfsync everysec
    no-appendfsync-on-rewrite no
    auto-aof-rewrite-percentage 100
    auto-aof-rewrite-min-size 64mb
    lua-time-limit 5000
    slowlog-log-slower-than 10000
    slowlog-max-len 128
    notify-keyspace-events Ex
    hash-max-ziplist-entries 512
    hash-max-ziplist-value 64
    list-max-ziplist-entries 512
    list-max-ziplist-value 64
    set-max-intset-entries 512
    zset-max-ziplist-entries 128
    zset-max-ziplist-value 64
    hll-sparse-max-bytes 3000
    activerehashing yes
name: Documentation Validation

on:
  push:
    branches: [ main, razionalizzazione-sp, develop ]
    paths:
      - 'docs/**'
      - 'scripts/verify_*.py'
      - '.github/workflows/docs-validation.yml'
  pull_request:
    branches: [ main, razionalizzazione-sp ]
    paths:
      - 'docs/**'
      - 'scripts/verify_*.py'

jobs:
  validate-documentation:
    runs-on: ubuntu-latest
    name: Validate Documentation

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Run SP/MS References Validation
        run: |
          python3 scripts/verify_sp_references.py
          echo "SP/MS References validation completed"

      - name: Run JSON Examples Validation
        run: |
          python3 scripts/verify_json_examples.py
          echo "JSON Examples validation completed"

      - name: Run Links Validation
        run: |
          python3 scripts/verify_links.py
          echo "Links validation completed"

      - name: Upload validation reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: validation-reports
          path: scripts/reports/
          retention-days: 30

      # Commenting on PRs is now handled by `.github/workflows/docs-comment.yml`
      # which runs in `pull_request_target` context to safely post comments
      # (avoids 403 on PRs from forks). The validation job only uploads artifacts.

      - name: Fail if validation errors found
        run: |
          if [ -f scripts/reports/sp_ms_references.json ]; then
            errors=$(python3 -c "import json; f=open('scripts/reports/sp_ms_references.json'); data=json.load(f); print(data['summary']['errors'])" 2>/dev/null || echo "0")
            if [ "$errors" != "0" ]; then
              echo "❌ SP/MS References validation failed with $errors errors"
              exit 1
            fi
          fi

          if [ -f scripts/reports/json_validation.json ]; then
            errors=$(python3 -c "import json; f=open('scripts/reports/json_validation.json'); data=json.load(f); print(data['summary']['errors'])" 2>/dev/null || echo "0")
            if [ "$errors" != "0" ]; then
              echo "❌ JSON validation failed with $errors errors"
              exit 1
            fi
          fi

          # Links validation è FASE 1 non-critico: solo reporting
          # Gli errori rimangono visibili nei report per FASE 2-3
          if [ -f scripts/reports/links_validation.json ]; then
            errors=$(python3 -c "import json; f=open('scripts/reports/links_validation.json'); data=json.load(f); print(data['summary']['errors'])" 2>/dev/null || echo "0")
            if [ "$errors" != "0" ]; then
              echo "⚠️  Links validation: $errors broken links (will be fixed in FASE 2-3)"
            else
              echo "✅ Links validation: All links OK"
            fi
          fi

          echo "✅ All critical documentation validations passed"
